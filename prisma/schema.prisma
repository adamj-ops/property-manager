// Everyday Properties Management Platform
// Complete Database Schema for Supabase (PostgreSQL)
//
// Run migrations:
//   pnpm prisma migrate dev --name init
//   pnpm prisma generate
//
// Better Auth CLI:
//   pnpm dlx @better-auth/cli generate --config src/server/auth.ts

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pgcrypto]
}

// =============================================================================
// AUTHENTICATION & USER MANAGEMENT (Better Auth)
// =============================================================================

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  username      String?   @unique
  role          String?   @default("user")
  banned        Boolean?  @default(false)
  banReason     String?
  banExpires    DateTime?

  // Onboarding fields
  phone                 String?
  userRole              String?   // "property_manager", "owner", "leasing_agent", "portfolio_manager", "other"
  onboardingCompletedAt DateTime?

  // Relations
  sessions           Session[]
  accounts           Account[]
  preference         Preference?
  properties         Property[]           @relation("PropertyManager")
  assignedWorkOrders MaintenanceRequest[] @relation("AssignedTo")
  createdWorkOrders  MaintenanceRequest[] @relation("CreatedBy")
  createdSchedules   MaintenanceSchedule[]
  sentMessages       Message[]            @relation("MessageSender")
  auditLogs          AuditLog[]
  createdDocuments   Document[]           @relation("DocumentUploader")
  teamMemberships    TeamMember[]
  ownedTeams         Team[]               @relation("TeamOwner")
  createdTemplates   LeaseTemplate[]      @relation("TemplateCreator")
  tenantProfile      Tenant?              @relation("TenantUser") // Tenant portal access
  maintenanceTemplates MaintenanceTemplate[] @relation("MaintenanceTemplateCreator")
  createdCostLineItems MaintenanceCostLineItem[] @relation("CostLineItemCreator")

  @@map("users")
}

model Session {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expiresAt      DateTime
  token          String   @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  ipAddress      String?
  userAgent      String?
  userId         String   @db.Uuid
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy String?

  @@map("sessions")
}

model Account {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId             String
  providerId            String
  userId                String    @db.Uuid
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("accounts")
}

model Preference {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @unique @db.Uuid
  data      Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("preferences")
}

model Verification {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}

// =============================================================================
// MULTI-TENANCY (Teams)
// =============================================================================

enum TeamRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

model Team {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String  @unique // URL-friendly identifier
  description String?

  // Branding
  logoUrl      String?
  primaryColor String?

  // Settings
  settings Json @default("{}")

  // Subscription/Billing (for future use)
  plan          String    @default("free")
  planExpiresAt DateTime?

  // Onboarding data
  unitsManaged     String? // "1-10", "11-50", "51-200", "200+"
  signupReason     String? // "switching", "new_business", "spreadsheets", "scaling", "new_properties", "compliance", "other"
  previousPlatform String? // "buildium", "appfolio", "rent_manager", "tenantcloud", "propertyware", "other"

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownerId    String       @db.Uuid
  owner      User         @relation("TeamOwner", fields: [ownerId], references: [id])
  members    TeamMember[]
  properties Property[]   @relation("TeamProperties")

  @@index([ownerId])
  @@map("teams")
}

model TeamMember {
  id   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  role TeamRole @default(MEMBER)

  // Invitation tracking
  invitedAt      DateTime  @default(now())
  invitedByEmail String?
  acceptedAt     DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teamId String @db.Uuid
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

// =============================================================================
// PROPERTY MANAGEMENT
// =============================================================================

enum PropertyType {
  SINGLE_FAMILY
  MULTI_FAMILY
  APARTMENT
  CONDO
  TOWNHOUSE
  COMMERCIAL
  MIXED_USE
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
  UNDER_RENOVATION
  FOR_SALE
}

model Property {
  id     String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name   String
  type   PropertyType   @default(MULTI_FAMILY)
  status PropertyStatus @default(ACTIVE)

  // Address
  addressLine1 String
  addressLine2 String?
  city         String
  state        String   @default("MN")
  zipCode      String
  country      String   @default("US")
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)

  // Property Details
  yearBuilt     Int?
  totalUnits    Int      @default(1)
  totalSqFt     Int?
  lotSize       Decimal? @db.Decimal(10, 2)
  parkingSpaces Int?
  amenities     String[] @default([])

  // Compliance
  rentalLicenseNumber String?
  rentalLicenseExpiry DateTime?
  leadPaintDisclosure Boolean   @default(false)
  builtBefore1978     Boolean   @default(false)

  // Financial
  purchasePrice   Decimal?  @db.Decimal(12, 2)
  purchaseDate    DateTime?
  currentValue    Decimal?  @db.Decimal(12, 2)
  mortgageBalance Decimal?  @db.Decimal(12, 2)

  // Metadata
  notes     String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  managerId   String       @db.Uuid
  manager     User         @relation("PropertyManager", fields: [managerId], references: [id])
  teamId      String?      @db.Uuid
  team        Team?        @relation("TeamProperties", fields: [teamId], references: [id])
  units                Unit[]
  expenses             Expense[]
  documents            Document[]
  inspections          Inspection[]
  maintenanceSchedules MaintenanceSchedule[]

  @@index([managerId])
  @@index([teamId])
  @@index([status])
  @@index([city, state])
  @@map("pm_properties")
}

// =============================================================================
// UNIT MANAGEMENT
// =============================================================================

enum UnitStatus {
  VACANT
  OCCUPIED
  NOTICE_GIVEN
  UNDER_RENOVATION
  OFF_MARKET
}

model Unit {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unitNumber String
  status     UnitStatus @default(VACANT)

  // Unit Details
  floorPlan String?
  bedrooms  Int     @default(1)
  bathrooms Decimal @default(1) @db.Decimal(2, 1)
  sqFt      Int?
  floor     Int?

  // Rent Information
  marketRent    Decimal  @db.Decimal(10, 2)
  currentRent   Decimal? @db.Decimal(10, 2)
  depositAmount Decimal? @db.Decimal(10, 2)

  // Features
  features    String[] @default([])
  petFriendly Boolean  @default(false)
  petDeposit  Decimal? @db.Decimal(10, 2)
  petRent     Decimal? @db.Decimal(10, 2)

  // Appliances & Utilities
  appliances        String[] @default([])
  utilitiesIncluded String[] @default([])

  // Metadata
  notes     String?
  imageUrls String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  propertyId          String               @db.Uuid
  property            Property             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  leases              Lease[]
  maintenanceRequests MaintenanceRequest[]
  maintenanceSchedules MaintenanceSchedule[]

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@index([status])
  @@map("pm_units")
}

// =============================================================================
// TENANT MANAGEMENT
// =============================================================================

enum TenantStatus {
  APPLICANT
  APPROVED
  ACTIVE
  PAST
  EVICTED
  DENIED
}

model Tenant {
  id     String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status TenantStatus @default(APPLICANT)

  // Personal Information
  firstName   String
  lastName    String
  email       String    @unique
  phone       String?
  altPhone    String?
  dateOfBirth DateTime?

  // Identification (encrypted in application layer)
  ssn            String? // Last 4 only or encrypted
  driversLicense String?

  // Emergency Contact
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  // Employment
  employer      String?
  employerPhone String?
  jobTitle      String?
  monthlyIncome Decimal? @db.Decimal(10, 2)

  // Previous Rental
  previousAddress       String?
  previousLandlord      String?
  previousLandlordPhone String?
  reasonForLeaving      String?

  // Vehicle Information
  vehicleMake  String?
  vehicleModel String?
  vehicleYear  Int?
  vehicleColor String?
  licensePlate String?

  // Preferences
  preferredContactMethod String? @default("email")

  // Stripe Integration
  stripeCustomerId    String? @unique // Stripe customer ID for payment processing
  paymentFailureCount Int     @default(0) // Track consecutive payment failures for late fee escalation

  // User Account Link (for tenant portal access)
  userId String? @unique @db.Uuid
  user   User?   @relation("TenantUser", fields: [userId], references: [id])

  // Metadata
  notes     String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  leases              Lease[]
  pets                Pet[]
  maintenanceRequests MaintenanceRequest[]
  messages            Message[]
  payments            Payment[]
  documents           Document[]

  @@index([status])
  @@index([email])
  @@index([lastName, firstName])
  @@map("pm_tenants")
}

// =============================================================================
// LEASE MANAGEMENT
// =============================================================================

enum LeaseStatus {
  DRAFT
  PENDING_SIGNATURE
  ACTIVE
  EXPIRED
  RENEWED
  TERMINATED
  MONTH_TO_MONTH
}

enum LeaseType {
  FIXED_TERM
  MONTH_TO_MONTH
  WEEK_TO_WEEK
}

model Lease {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leaseNumber String      @unique @default(dbgenerated("'LS-' || to_char(now(), 'YYYYMMDD') || '-' || substr(gen_random_uuid()::text, 1, 8)"))
  status      LeaseStatus @default(DRAFT)
  type        LeaseType   @default(FIXED_TERM)

  // Lease Term
  startDate   DateTime
  endDate     DateTime
  moveInDate  DateTime?
  moveOutDate DateTime?
  signedDate  DateTime?

  // Rent Information
  monthlyRent      Decimal @db.Decimal(10, 2)
  rentDueDay       Int     @default(1)
  lateFeeAmount    Decimal @default(50) @db.Decimal(10, 2) // MN cap is $50
  lateFeeGraceDays Int     @default(5)

  // Security Deposit (MN Compliance: 504B.178)
  securityDeposit     Decimal   @db.Decimal(10, 2)
  depositPaidDate     DateTime?
  depositInterestRate Decimal   @default(0.01) @db.Decimal(5, 4) // MN: 1% annually
  depositBankName     String?
  depositAccountLast4 String?

  // Pet Information
  petsAllowed Boolean  @default(false)
  petDeposit  Decimal? @db.Decimal(10, 2)
  petRent     Decimal? @db.Decimal(10, 2)

  // Utilities & Responsibilities
  utilitiesTenantPays String[] @default([])
  utilitiesOwnerPays  String[] @default([])

  // Additional Terms
  parkingIncluded Boolean  @default(false)
  parkingFee      Decimal? @db.Decimal(10, 2)
  storageIncluded Boolean  @default(false)
  storageFee      Decimal? @db.Decimal(10, 2)

  // Renewal
  autoRenew           Boolean  @default(false)
  renewalNoticeDays   Int      @default(60)
  renewalRentIncrease Decimal? @db.Decimal(5, 2) // Percentage

  // Documents
  leaseDocumentUrl  String?
  signedDocumentUrl String?

  // Stripe Integration
  stripeSubscriptionId String? @unique // Stripe subscription ID for recurring rent payments

  // Metadata
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  unitId   String @db.Uuid
  unit     Unit   @relation(fields: [unitId], references: [id])
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Renewal Tracking
  renewedFromLeaseId String? @unique @db.Uuid @map("renewed_from_lease_id")
  renewedFromLease   Lease?  @relation("LeaseRenewal", fields: [renewedFromLeaseId], references: [id])
  renewedToLease     Lease?  @relation("LeaseRenewal")

  coTenants           LeaseTenant[]
  addenda             LeaseAddendum[]
  payments            Payment[]
  inspections         Inspection[]
  depositDisposition  DepositDisposition?

  @@index([unitId])
  @@index([tenantId])
  @@index([status])
  @@index([endDate])
  @@index([renewedFromLeaseId])
  @@map("pm_leases")
}

model LeaseTenant {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leaseId   String    @db.Uuid
  lease     Lease     @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenantId  String    @db.Uuid
  isPrimary Boolean   @default(false)
  signedAt  DateTime?
  createdAt DateTime  @default(now())

  @@unique([leaseId, tenantId])
  @@map("lease_tenants")
}

model LeaseAddendum {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leaseId       String    @db.Uuid
  lease         Lease     @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  title         String
  content       String
  effectiveDate DateTime
  signedDate    DateTime?
  documentUrl   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([leaseId])
  @@map("lease_addenda")
}

// =============================================================================
// PET MANAGEMENT
// =============================================================================

enum PetType {
  DOG
  CAT
  BIRD
  FISH
  REPTILE
  SMALL_MAMMAL
  OTHER
}

enum PetStatus {
  PENDING
  APPROVED
  DENIED
  REMOVED
}

model Pet {
  id     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status PetStatus @default(PENDING)
  type   PetType

  name   String
  breed  String?
  color  String?
  weight Decimal? @db.Decimal(5, 2)
  age    Int?

  // Vaccination & Registration
  vaccinated        Boolean   @default(false)
  vaccinationExpiry DateTime?
  rabiesTagNumber   String?
  licensedWithCity  Boolean   @default(false)

  // Approval
  approvedAt   DateTime?
  deniedAt     DateTime?
  denialReason String?

  // Metadata
  imageUrl  String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("pets")
}

// =============================================================================
// MAINTENANCE & WORK ORDERS
// =============================================================================

enum MaintenanceStatus {
  SUBMITTED
  ACKNOWLEDGED
  SCHEDULED
  IN_PROGRESS
  PENDING_PARTS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum MaintenancePriority {
  EMERGENCY
  HIGH
  MEDIUM
  LOW
}

enum MaintenanceCategory {
  PLUMBING
  ELECTRICAL
  HVAC
  APPLIANCE
  STRUCTURAL
  PEST_CONTROL
  LANDSCAPING
  CLEANING
  PAINTING
  FLOORING
  WINDOWS_DOORS
  ROOF
  SAFETY
  OTHER
}

model MaintenanceRequest {
  id            String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requestNumber String              @unique @default(dbgenerated("'WO-' || to_char(now(), 'YYYYMMDD') || '-' || substr(gen_random_uuid()::text, 1, 8)"))
  status        MaintenanceStatus   @default(SUBMITTED)
  priority      MaintenancePriority @default(MEDIUM)
  category      MaintenanceCategory

  // Request Details
  title             String
  description       String
  location          String? // e.g., "Kitchen", "Master Bathroom"
  permissionToEnter Boolean @default(true)
  preferredTimes    String?

  // Scheduling
  scheduledDate     DateTime?
  scheduledTime     String?
  estimatedDuration Int? // in minutes
  completedAt       DateTime?

  // Cost Tracking
  estimatedCost Decimal? @db.Decimal(10, 2)
  actualCost    Decimal? @db.Decimal(10, 2)
  tenantCharge  Decimal? @db.Decimal(10, 2) // Amount charged to tenant

  // Documentation
  photoUrls        String[] @default([])
  completionNotes  String?
  completionPhotos String[] @default([])

  // Emergency Escalation
  escalationLevel          Int       @default(0) // 0=none, 1=initial alert, 2=escalated, 3=critical
  lastEscalatedAt          DateTime? // When the last escalation notification was sent
  escalationAcknowledgedAt DateTime? // When someone acknowledged the escalation
  escalationAcknowledgedById String? @db.Uuid // Who acknowledged the escalation

  // SLA Tracking
  slaResponseHours   Int?      // Target hours to first response (acknowledgement)
  slaResolutionHours Int?      // Target hours to resolution (completion)
  firstRespondedAt   DateTime? // When work order was first acknowledged
  slaResponseDueAt   DateTime? // Calculated: createdAt + slaResponseHours
  slaResolutionDueAt DateTime? // Calculated: createdAt + slaResolutionHours

  // Template reference
  templateId String? @db.Uuid

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  unitId       String  @db.Uuid
  unit         Unit    @relation(fields: [unitId], references: [id])
  tenantId     String? @db.Uuid
  tenant       Tenant? @relation(fields: [tenantId], references: [id])
  assignedToId String? @db.Uuid
  assignedTo   User?   @relation("AssignedTo", fields: [assignedToId], references: [id])
  createdById  String  @db.Uuid
  createdBy    User    @relation("CreatedBy", fields: [createdById], references: [id])
  vendorId     String? @db.Uuid
  vendor       Vendor? @relation(fields: [vendorId], references: [id])

  // If generated from a schedule
  scheduleId   String?              @db.Uuid
  schedule     MaintenanceSchedule? @relation("ScheduleGenerated", fields: [scheduleId], references: [id], onDelete: SetNull)

  comments      MaintenanceComment[]
  statusHistory WorkOrderStatusHistory[]
  expenses      Expense[]
  costLineItems MaintenanceCostLineItem[]

  @@index([unitId])
  @@index([scheduleId])
  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdAt])
  @@map("pm_maintenance_requests")
}

model MaintenanceComment {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content    String
  isInternal Boolean  @default(false) // Internal notes vs visible to tenant
  authorName String
  authorType String // "staff", "tenant", "vendor"
  createdAt  DateTime @default(now())

  // Attachments (file paths stored in Supabase Storage)
  attachments String[] @default([])

  requestId String             @db.Uuid
  request   MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("maintenance_comments")
}

model WorkOrderStatusHistory {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Status transition
  fromStatus MaintenanceStatus?
  toStatus   MaintenanceStatus

  // Context
  reason String? // Why the status changed
  notes  String? // Additional notes about the transition

  // Who made the change
  changedByName String
  changedByType String // "staff", "system", "vendor"

  // Metadata
  createdAt DateTime @default(now())

  // Relations
  requestId String             @db.Uuid
  request   MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([createdAt])
  @@map("work_order_status_history")
}

// =============================================================================
// MAINTENANCE COST LINE ITEMS (EPM-76)
// =============================================================================

enum CostLineItemType {
  LABOR
  PARTS
  MATERIALS
  PERMITS
  TRAVEL
  EMERGENCY_FEE
  DISPOSAL
  SUBCONTRACTOR
  OTHER
}

model MaintenanceCostLineItem {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requestId   String           @db.Uuid
  request     MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // Item details
  type        CostLineItemType
  description String
  quantity    Decimal          @db.Decimal(10, 2) @default(1)
  unitCost    Decimal          @db.Decimal(10, 2)
  totalCost   Decimal          @db.Decimal(10, 2) // quantity * unitCost

  // Parts tracking
  partNumber      String?
  supplier        String?
  warranty        Boolean      @default(false)
  warrantyExpiry  DateTime?

  // Labor tracking
  laborHours  Decimal?         @db.Decimal(5, 2)
  laborRate   Decimal?         @db.Decimal(10, 2)
  workerId    String?          // Vendor employee name or ID

  // Documentation
  receiptUrl  String?

  // Tenant billing
  chargeToTenant      Boolean  @default(false)
  tenantChargeAmount  Decimal? @db.Decimal(10, 2)

  // Audit
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdById String           @db.Uuid
  createdBy   User             @relation("CostLineItemCreator", fields: [createdById], references: [id])

  @@index([requestId])
  @@index([type])
  @@map("maintenance_cost_line_items")
}

// =============================================================================
// RECURRING MAINTENANCE SCHEDULES
// =============================================================================

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  BIANNUALLY
  ANNUALLY
}

model MaintenanceSchedule {
  id     String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name   String // e.g., "HVAC Filter Change", "Quarterly Inspection"
  isActive Boolean @default(true)

  // What to create
  category    MaintenanceCategory
  priority    MaintenancePriority @default(MEDIUM)
  title       String // Title for generated work orders
  description String // Description for generated work orders
  location    String? // e.g., "All HVAC units"

  // Recurrence settings
  frequency      RecurrenceFrequency
  intervalCount  Int                  @default(1) // e.g., every 2 weeks
  dayOfWeek      Int?                 // 0-6 for weekly (Sunday = 0)
  dayOfMonth     Int?                 // 1-31 for monthly
  monthOfYear    Int?                 // 1-12 for annually

  // Scheduling
  startDate      DateTime             // When the schedule starts
  endDate        DateTime?            // Optional end date
  nextRunAt      DateTime             // Next scheduled execution
  lastRunAt      DateTime?            // Last time a work order was created

  // Cost estimate
  estimatedCost  Decimal?             @db.Decimal(10, 2)
  estimatedDuration Int?              // in minutes

  // Assignment
  autoAssignVendor Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  propertyId String?  @db.Uuid
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unitId     String?  @db.Uuid
  unit       Unit?    @relation(fields: [unitId], references: [id], onDelete: Cascade)
  vendorId   String?  @db.Uuid
  vendor     Vendor?  @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  createdById String  @db.Uuid
  createdBy   User    @relation(fields: [createdById], references: [id])

  // Track generated work orders
  generatedRequests MaintenanceRequest[] @relation("ScheduleGenerated")

  @@index([nextRunAt])
  @@index([isActive])
  @@index([propertyId])
  @@index([unitId])
  @@map("pm_maintenance_schedules")
}

// =============================================================================
// VENDOR MANAGEMENT
// =============================================================================

enum VendorStatus {
  ACTIVE
  INACTIVE
  PENDING_APPROVAL
  SUSPENDED
}

model Vendor {
  id     String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status VendorStatus @default(ACTIVE)

  // Business Information
  companyName String
  contactName String
  email       String  @unique
  phone       String
  altPhone    String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zipCode      String?

  // Services
  categories   MaintenanceCategory[]
  serviceAreas String[]              @default([]) // Zip codes or cities served
  hourlyRate   Decimal?              @db.Decimal(10, 2)

  // Insurance & Licensing
  insuranceProvider  String?
  insurancePolicyNum String?
  insuranceExpiry    DateTime?
  licenseNumber      String?
  licenseExpiry      DateTime?

  // Payment
  taxId        String? // EIN or SSN for 1099
  paymentTerms Int     @default(30) // Net days

  // Rating
  rating    Decimal? @db.Decimal(2, 1) // 1.0 - 5.0
  totalJobs Int      @default(0)

  // Metadata
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  maintenanceRequests  MaintenanceRequest[]
  maintenanceSchedules MaintenanceSchedule[]
  expenses             Expense[]

  @@index([status])
  @@map("pm_vendors")
}

// =============================================================================
// FINANCIAL MANAGEMENT
// =============================================================================

enum PaymentType {
  RENT
  SECURITY_DEPOSIT
  PET_DEPOSIT
  PET_RENT
  LATE_FEE
  PARKING
  STORAGE
  UTILITY
  MOVE_IN_FEE
  APPLICATION_FEE
  OTHER
}

enum PaymentMethod {
  CHECK
  CASH
  ACH
  CREDIT_CARD
  DEBIT_CARD
  MONEY_ORDER
  ONLINE_PORTAL
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIAL
  CANCELLED
}

model Payment {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentNumber String        @unique @default(dbgenerated("'PAY-' || to_char(now(), 'YYYYMMDD') || '-' || substr(gen_random_uuid()::text, 1, 8)"))
  type          PaymentType
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)

  // Amount
  amount        Decimal  @db.Decimal(10, 2)
  appliedAmount Decimal? @db.Decimal(10, 2) // Actual amount applied to balance

  // Payment Details
  paymentDate  DateTime
  dueDate      DateTime?
  receivedDate DateTime?

  // Reference
  referenceNumber String? // Check number, transaction ID, etc.
  memo            String?

  // For partial payments
  forPeriodStart DateTime?
  forPeriodEnd   DateTime?

  // Stripe Integration
  stripePaymentIntentId String? @unique // Stripe payment intent ID
  stripeChargeId        String? // Stripe charge ID (for refunds)
  stripePaymentMethodId String? // Payment method used for this payment
  stripeFeeAmount       Decimal? @db.Decimal(10, 2) // Stripe processing fee
  failureReason         String? // Reason for payment failure

  // Refund tracking
  refundedAt     DateTime? // When the payment was refunded
  refundAmount   Decimal?  @db.Decimal(10, 2) // Amount refunded (supports partial refunds)

  // Processing
  processedAt   DateTime?
  processingFee Decimal?  @db.Decimal(10, 2)

  // Metadata
  notes      String?
  receiptUrl String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenantId String  @db.Uuid
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  leaseId  String? @db.Uuid
  lease    Lease?  @relation(fields: [leaseId], references: [id])

  @@index([tenantId])
  @@index([leaseId])
  @@index([paymentDate])
  @@index([status])
  @@map("payments")
}

// Stripe Webhook Event Tracking (for idempotency)
model StripeWebhook {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId     String   @unique // Stripe event ID (evt_xxx)
  eventType   String   // Event type (e.g., payment_intent.succeeded)
  processed   Boolean  @default(false)
  processedAt DateTime?
  payload     Json?    // Raw event payload for debugging
  error       String?  // Error message if processing failed
  createdAt   DateTime @default(now())

  @@index([eventId])
  @@index([eventType])
  @@index([processed])
  @@map("stripe_webhooks")
}

enum ExpenseCategory {
  MAINTENANCE
  REPAIRS
  UTILITIES
  INSURANCE
  PROPERTY_TAX
  MORTGAGE
  HOA_FEES
  MANAGEMENT_FEE
  LEGAL
  ADVERTISING
  SUPPLIES
  LANDSCAPING
  CLEANING
  PEST_CONTROL
  CAPITAL_IMPROVEMENT
  OTHER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
  CANCELLED
}

model Expense {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expenseNumber String          @unique @default(dbgenerated("'EXP-' || to_char(now(), 'YYYYMMDD') || '-' || substr(gen_random_uuid()::text, 1, 8)"))
  category      ExpenseCategory
  status        ExpenseStatus   @default(PENDING)

  // Amount
  amount        Decimal @db.Decimal(10, 2)
  taxDeductible Boolean @default(true)

  // Details
  description String
  expenseDate DateTime
  dueDate     DateTime?
  paidDate    DateTime?

  // Reference
  invoiceNumber   String?
  referenceNumber String?

  // Metadata
  receiptUrl String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  propertyId           String              @db.Uuid
  property             Property            @relation(fields: [propertyId], references: [id])
  vendorId             String?             @db.Uuid
  vendor               Vendor?             @relation(fields: [vendorId], references: [id])
  maintenanceRequestId String?             @db.Uuid
  maintenanceRequest   MaintenanceRequest? @relation(fields: [maintenanceRequestId], references: [id])

  @@index([propertyId])
  @@index([category])
  @@index([expenseDate])
  @@map("expenses")
}

// =============================================================================
// COMMUNICATION
// =============================================================================

enum MessageType {
  EMAIL
  SMS
  IN_APP
  NOTICE
}

enum MessageStatus {
  DRAFT
  SCHEDULED
  SENT
  DELIVERED
  FAILED
  READ
}

model Message {
  id     String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type   MessageType   @default(EMAIL)
  status MessageStatus @default(DRAFT)

  // Content
  subject  String?
  body     String
  htmlBody String?

  // Scheduling
  scheduledAt DateTime?
  sentAt      DateTime?
  readAt      DateTime?

  // Delivery Info
  deliveryError String?
  externalId    String? // SendGrid ID, Twilio SID, etc.

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  senderId   String           @db.Uuid
  sender     User             @relation("MessageSender", fields: [senderId], references: [id])
  tenantId   String?          @db.Uuid
  tenant     Tenant?          @relation(fields: [tenantId], references: [id])
  templateId String?          @db.Uuid
  template   MessageTemplate? @relation(fields: [templateId], references: [id])

  @@index([senderId])
  @@index([tenantId])
  @@index([status])
  @@map("messages")
}

model MessageTemplate {
  id   String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String      @unique
  type MessageType @default(EMAIL)

  // Content
  subject  String?
  body     String
  htmlBody String?

  // Variables available: {{tenant.firstName}}, {{property.name}}, {{unit.number}}, etc.
  variables String[] @default([])

  // Usage
  category String? // "payment_reminder", "lease_renewal", "maintenance", etc.
  isActive Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages Message[]

  @@map("message_templates")
}

// =============================================================================
// DOCUMENT MANAGEMENT
// =============================================================================

enum DocumentType {
  LEASE
  ADDENDUM
  APPLICATION
  ID_DOCUMENT
  INCOME_VERIFICATION
  INSPECTION_REPORT
  PHOTO
  INVOICE
  RECEIPT
  NOTICE
  CORRESPONDENCE
  INSURANCE
  LICENSE
  OTHER
}

enum DocumentStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  DELETED
}

model Document {
  id     String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type   DocumentType
  status DocumentStatus @default(ACTIVE)

  // File Info
  fileName    String
  fileSize    Int // bytes
  mimeType    String
  fileUrl     String
  storagePath String? @map("storage_path")

  // Metadata
  title       String?
  description String?
  tags        String[] @default([])

  // Expiration
  expiresAt DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  uploadedById String    @db.Uuid
  uploadedBy   User      @relation("DocumentUploader", fields: [uploadedById], references: [id])
  propertyId   String?   @db.Uuid
  property     Property? @relation(fields: [propertyId], references: [id])
  tenantId     String?   @db.Uuid
  tenant       Tenant?   @relation(fields: [tenantId], references: [id])

  @@index([type])
  @@index([propertyId])
  @@index([tenantId])
  @@map("documents")
}

// =============================================================================
// INSPECTIONS
// =============================================================================

enum InspectionType {
  MOVE_IN
  MOVE_OUT
  ROUTINE
  MAINTENANCE
  SAFETY
  ANNUAL
}

enum InspectionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Inspection {
  id     String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type   InspectionType
  status InspectionStatus @default(SCHEDULED)

  // Scheduling
  scheduledDate DateTime
  completedDate DateTime?

  // Results
  overallCondition String? // "Excellent", "Good", "Fair", "Poor"
  notes            String?

  // AI Analysis (Phase 2)
  aiAnalysisRun Boolean  @default(false)
  aiFindings    Json? // Structured AI analysis results
  aiConfidence  Decimal? @db.Decimal(3, 2) // 0.00 - 1.00

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  propertyId String   @db.Uuid
  property   Property @relation(fields: [propertyId], references: [id])
  leaseId    String?  @db.Uuid
  lease      Lease?   @relation(fields: [leaseId], references: [id])

  items       InspectionItem[]
  damageItems DamageItem[]

  @@index([propertyId])
  @@index([type])
  @@index([scheduledDate])
  @@map("inspections")
}

model InspectionItem {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Location & Item
  room String // "Living Room", "Kitchen", etc.
  item String // "Walls", "Flooring", "Windows", etc.

  // Condition Rating
  condition String // "New", "Good", "Fair", "Poor", "Damaged"

  // Details
  notes     String?
  photoUrls String[] @default([])

  // Damage Assessment
  hasDamage           Boolean  @default(false)
  damageDescription   String?
  estimatedRepairCost Decimal? @db.Decimal(10, 2)
  tenantResponsible   Boolean  @default(false)

  // Metadata
  createdAt DateTime @default(now())

  // Relations
  inspectionId String     @db.Uuid
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@map("inspection_items")
}

// =============================================================================
// MOVE-OUT & DEPOSIT DISPOSITION (MN Compliance: 504B.178)
// =============================================================================

enum DepositDispositionStatus {
  DRAFT
  PENDING_REVIEW
  SENT
  ACKNOWLEDGED
  DISPUTED
}

enum SendMethod {
  CERTIFIED_MAIL
  REGULAR_MAIL
  EMAIL
  HAND_DELIVERED
}

model DamageItem {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Damage Details
  description String
  location    String? // Room or area

  // Cost Assessment
  repairCost     Decimal @db.Decimal(10, 2)
  isNormalWear   Boolean @default(false)
  isPreExisting  Boolean @default(false)

  // Documentation
  photoUrls String[] @default([])
  notes     String?

  // Comparison to Move-In (optional link to move-in item)
  moveInItemId String? @db.Uuid @map("move_in_item_id")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  inspectionId String     @db.Uuid @map("inspection_id")
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@map("pm_damage_items")
}

model DepositDisposition {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Deposit Details
  originalDeposit  Decimal @db.Decimal(10, 2) @map("original_deposit")
  interestAccrued  Decimal @db.Decimal(10, 2) @map("interest_accrued")
  totalDeductions  Decimal @default(0) @db.Decimal(10, 2) @map("total_deductions")
  refundAmount     Decimal @db.Decimal(10, 2) @map("refund_amount")

  // MN Compliance: Dates (21-day deadline)
  moveOutDate  DateTime @map("move_out_date")
  deadlineDate DateTime @map("deadline_date") // move_out + 21 days

  // Sending Details
  sentDate       DateTime?  @map("sent_date")
  sentMethod     SendMethod? @map("sent_method")
  trackingNumber String?    @map("tracking_number")

  // Letter Content
  letterPdfUrl        String? @map("letter_pdf_url")
  itemizedDeductions  Json?   @map("itemized_deductions") // Array of {description, amount, isNormalWear}

  // Bank Disclosure (MN Requirement)
  bankName     String? @map("bank_name")
  accountLast4 String? @map("account_last_4")

  // Refund Processing
  refundProcessedDate DateTime? @map("refund_processed_date")
  refundMethod        String?   @map("refund_method") // "CHECK", "ACH", "CASH"
  refundCheckNumber   String?   @map("refund_check_number")

  // Status
  status DepositDispositionStatus @default(DRAFT)

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  leaseId String @unique @db.Uuid @map("lease_id")
  lease   Lease  @relation(fields: [leaseId], references: [id])

  // Link to inspections
  moveInInspectionId  String? @db.Uuid @map("move_in_inspection_id")
  moveOutInspectionId String? @db.Uuid @map("move_out_inspection_id")

  @@index([leaseId])
  @@index([status])
  @@index([deadlineDate])
  @@map("pm_deposit_dispositions")
}

// =============================================================================
// AUDIT LOG (Compliance)
// =============================================================================

model AuditLog {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Action Details
  action     String // "CREATE", "UPDATE", "DELETE", "VIEW", "EXPORT"
  entityType String // "Property", "Tenant", "Lease", etc.
  entityId   String @db.Uuid

  // Changes
  oldValues Json?
  newValues Json?

  // Context
  ipAddress String?
  userAgent String?

  // Metadata
  createdAt DateTime @default(now())

  // Relations
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// LEASE TEMPLATES (EPM-83)
// =============================================================================

enum LeaseTemplateType {
  MAIN_LEASE
  ADDENDUM_PET
  ADDENDUM_PARKING
  ADDENDUM_CRIME_FREE
  ADDENDUM_LEAD_PAINT
  ADDENDUM_SECURITY_DEPOSIT
  ADDENDUM_UTILITIES
  ADDENDUM_SMOKING
  ADDENDUM_GUEST
  ADDENDUM_CUSTOM
}

model LeaseTemplate {
  id      String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name    String
  type    LeaseTemplateType
  version Int               @default(1)

  // Template Content
  templateFileUrl  String? @map("template_file_url")
  templateFilePath String? @map("template_file_path")
  templateContent  String? @map("template_content") @db.Text

  // Variable System
  variables      String[] @default([])
  variableSchema Json?    @map("variable_schema")

  // Template Metadata
  description String?
  isDefault   Boolean @default(false) @map("is_default")
  isActive    Boolean @default(true) @map("is_active")
  isArchived  Boolean @default(false) @map("is_archived")

  // Versioning
  parentTemplateId String?         @db.Uuid @map("parent_template_id")
  parentTemplate   LeaseTemplate?  @relation("TemplateVersions", fields: [parentTemplateId], references: [id], onDelete: SetNull)
  childTemplates   LeaseTemplate[] @relation("TemplateVersions")
  changeNotes      String?         @map("change_notes")

  // Compliance
  minnesotaCompliant Boolean @default(true) @map("minnesota_compliant")
  complianceNotes    String? @map("compliance_notes")

  // Metadata
  createdById String   @db.Uuid @map("created_by_id")
  createdBy   User     @relation("TemplateCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([name, version])
  @@index([type])
  @@index([isActive])
  @@index([isDefault])
  @@index([parentTemplateId])
  @@index([createdById])
  @@map("lease_templates")
}

// =============================================================================
// WORK ORDER TEMPLATES (EPM-XX)
// =============================================================================

model MaintenanceTemplate {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String // e.g., "Leaky Faucet", "HVAC Not Cooling"

  // Template fields
  category    MaintenanceCategory
  priority    MaintenancePriority @default(MEDIUM)
  title       String // Pre-filled title for work orders
  description String // Pre-filled description

  // SLA defaults
  slaResponseHours   Int? // Default response SLA for this type
  slaResolutionHours Int? // Default resolution SLA for this type

  // Cost estimates
  estimatedCost     Decimal? @db.Decimal(10, 2)
  estimatedDuration Int?     // in minutes

  // Suggested vendor category matching
  suggestVendorByCategory Boolean @default(true)

  // Status
  isActive Boolean @default(true)

  // Usage tracking
  usageCount Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdById String @db.Uuid
  createdBy   User   @relation("MaintenanceTemplateCreator", fields: [createdById], references: [id])

  @@index([category])
  @@index([isActive])
  @@index([createdById])
  @@map("maintenance_templates")
}
